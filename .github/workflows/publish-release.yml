name: Publish Release

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      monitor_permissions:
        type: boolean
        description: Monitor Permissions
        required: false
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  android:
    uses: ./.github/workflows/android-release.yml
    secrets:
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      GOOGLE_SERVICE_ACCOUNT_ID: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_ID }}
      FIREBASE_GOOGLE_SERVICES: ${{ secrets.FIREBASE_GOOGLE_SERVICES }}
      RELEASE_KEYSTORE_FILE: ${{ secrets.RELEASE_KEYSTORE_FILE }}
      RELEASE_KEYSTORE_PROPERTIES: ${{ secrets.RELEASE_KEYSTORE_PROPERTIES }}
      ANDROID_API_KEY: ${{ secrets.ANDROID_API_KEY }}
      BROWSER_API_KEY: ${{ secrets.BROWSER_API_KEY }}
      FASTLANE_SERVICE_ACCOUNT_KEY: ${{ secrets.FASTLANE_SERVICE_ACCOUNT_KEY }}

  github:
    needs: [ android ]
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: android-build-outputs
          path: tally-app/build/outputs

      - run: ls -R

      - uses: softprops/action-gh-release@v2
        with:
          files: |
            **/release/*.aar
            **/release/*.apk
          generate_release_notes: true
          draft: true

  play:
    needs: [android]
    runs-on: ubuntu-latest
    if: false

    steps:
      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - run: |
          play_store_key=${{ secrets.FASTLANE_SERVICE_ACCOUNT_KEY }}
          path=tally-app/src/androidMain/play-store-key.json
          echo $play_store_key | base64 --decode > $path

      - run: bundle install && bundle exec fastlane android publish_to_play_store
